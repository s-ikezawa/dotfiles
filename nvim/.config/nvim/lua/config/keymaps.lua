local map = vim.keymap.set

-- ============================================================================
-- 基本操作
-- ============================================================================

-- jk でノーマルモードに戻る (Escキーの代替)
map("i", "jk", "<Esc>", { desc = "ノーマルモードに戻る" })
map("t", "jk", "<C-\\><C-n>", { desc = "ターミナルからノーマルモードに戻る" })

-- Esc で検索ハイライトを消す (VSCode: Esc で検索ハイライト解除)
map("n", "<Esc>", "<Cmd>nohlsearch<CR>", { desc = "検索ハイライトを消す" })

-- ============================================================================
-- ファイル操作 (VSCode: Ctrl+S で保存)
-- ============================================================================

-- Ctrl+s でファイル保存
map({ "n", "i", "v" }, "<C-s>", "<Cmd>write<CR><Esc>", { desc = "ファイルを保存" })

-- ============================================================================
-- カーソル移動
-- ============================================================================

-- 挿入モードでの Emacs 風カーソル移動
map("i", "<C-a>", "<Home>", { desc = "行頭へ移動" })
map("i", "<C-e>", "<End>", { desc = "行末へ移動" })

-- 行の先頭・末尾へ移動 (H/L で行頭/行末)
map({ "n", "v" }, "H", "^", { desc = "行の最初の非空白文字へ移動" })
map({ "n", "v" }, "L", "$", { desc = "行末へ移動" })

-- 画面中央を維持したままスクロール
map("n", "<C-d>", "<C-d>zz", { desc = "半ページ下スクロール (中央維持)" })
map("n", "<C-u>", "<C-u>zz", { desc = "半ページ上スクロール (中央維持)" })

-- 検索結果ジャンプ時に画面中央を維持
map("n", "n", "nzzzv", { desc = "次の検索結果 (中央維持)" })
map("n", "N", "Nzzzv", { desc = "前の検索結果 (中央維持)" })

-- ============================================================================
-- 行操作 (VSCode: Alt+Up/Down で行移動)
-- ============================================================================

-- Alt+j/k で行を上下に移動
map("n", "<A-j>", "<Cmd>move .+1<CR>==", { desc = "行を下に移動" })
map("n", "<A-k>", "<Cmd>move .-2<CR>==", { desc = "行を上に移動" })
map("v", "<A-j>", ":move '>+1<CR>gv=gv", { desc = "選択行を下に移動" })
map("v", "<A-k>", ":move '<-2<CR>gv=gv", { desc = "選択行を上に移動" })
map("i", "<A-j>", "<Esc><Cmd>move .+1<CR>==gi", { desc = "行を下に移動" })
map("i", "<A-k>", "<Esc><Cmd>move .-2<CR>==gi", { desc = "行を上に移動" })

-- ============================================================================
-- インデント (VSCode: Tab/Shift+Tab でインデント)
-- ============================================================================

-- ビジュアルモードでインデント後も選択を維持
map("v", "<", "<gv", { desc = "インデントを下げる (選択維持)" })
map("v", ">", ">gv", { desc = "インデントを上げる (選択維持)" })

-- ============================================================================
-- コピー・ペースト (VSCode互換)
-- ============================================================================

-- ビジュアルモードでペースト時にレジスタを上書きしない
map("v", "p", '"_dP', { desc = "ペースト (レジスタ維持)" })

-- 行全体をヤンク (VSCode: Ctrl+C で行コピー)
map("n", "Y", "y$", { desc = "カーソルから行末までヤンク" })

-- ブラックホールレジスタへ削除 (削除してもヤンク内容を維持)
map({ "n", "v" }, "<Leader>d", '"_d', { desc = "削除 (レジスタを汚さない)" })

-- ============================================================================
-- ウィンドウ操作 (VSCode: エディタグループ操作)
-- ============================================================================

-- ウィンドウ分割 (VSCode: エディタの分割)
map("n", "<Leader>wv", "<Cmd>vsplit<CR>", { desc = "垂直分割" })
map("n", "<Leader>wh", "<Cmd>split<CR>", { desc = "水平分割" })
map("n", "<Leader>we", "<C-w>=", { desc = "ウィンドウサイズを均等化" })
map("n", "<Leader>wq", "<Cmd>close<CR>", { desc = "現在のウィンドウを閉じる" })

-- ウィンドウ間の移動 (Ctrl+hjkl)
map("n", "<C-h>", "<C-w>h", { desc = "左のウィンドウへ移動" })
map("n", "<C-j>", "<C-w>j", { desc = "下のウィンドウへ移動" })
map("n", "<C-k>", "<C-w>k", { desc = "上のウィンドウへ移動" })
map("n", "<C-l>", "<C-w>l", { desc = "右のウィンドウへ移動" })

-- ターミナルモードでもウィンドウ間を移動 (注意: <C-k>/<C-l> はシェルの行削除/画面クリアと競合)
map("t", "<C-h>", "<C-\\><C-n><C-w>h", { desc = "左のウィンドウへ移動" })
-- map("t", "<C-j>", "<C-\\><C-n><C-w>j", { desc = "下のウィンドウへ移動" })
-- map("t", "<C-k>", "<C-\\><C-n><C-w>k", { desc = "上のウィンドウへ移動" })
-- map("t", "<C-l>", "<C-\\><C-n><C-w>l", { desc = "右のウィンドウへ移動" })

-- ウィンドウサイズの変更 (VSCode: エディタサイズ調整)
map("n", "<C-Up>", "<Cmd>resize +2<CR>", { desc = "ウィンドウを縦に広げる" })
map("n", "<C-Down>", "<Cmd>resize -2<CR>", { desc = "ウィンドウを縦に縮める" })
map("n", "<C-Left>", "<Cmd>vertical resize -2<CR>", { desc = "ウィンドウを横に縮める" })
map("n", "<C-Right>", "<Cmd>vertical resize +2<CR>", { desc = "ウィンドウを横に広げる" })

-- ============================================================================
-- バッファ操作 (VSCode: タブ操作)
-- ============================================================================

-- バッファ切り替え (VSCode: Ctrl+Tab でタブ切り替え)
map("n", "<S-h>", "<Cmd>bprevious<CR>", { desc = "前のバッファへ" })
map("n", "<S-l>", "<Cmd>bnext<CR>", { desc = "次のバッファへ" })
map("n", "<Leader>bd", "<Cmd>bdelete<CR>", { desc = "バッファを閉じる" })
map("n", "<Leader>bo", "<Cmd>%bdelete|edit#|bdelete#<CR>", { desc = "他のバッファをすべて閉じる" })

-- ============================================================================
-- タブ操作
-- ============================================================================

map("n", "<Leader>tn", "<Cmd>tabnew<CR>", { desc = "新しいタブを開く" })
map("n", "<Leader>tq", "<Cmd>tabclose<CR>", { desc = "タブを閉じる" })
map("n", "<Leader>tl", "<Cmd>tabnext<CR>", { desc = "次のタブへ" })
map("n", "<Leader>th", "<Cmd>tabprevious<CR>", { desc = "前のタブへ" })

-- ============================================================================
-- 選択 (VSCode: 各種選択操作)
-- ============================================================================

-- Ctrl+a で全選択 (VSCode: Ctrl+A)
map("n", "<C-a>", "ggVG", { desc = "全選択" })

-- ============================================================================
-- テキスト操作
-- ============================================================================

-- J で行結合時にカーソル位置を維持
map("n", "J", "mzJ`z", { desc = "行を結合 (カーソル位置維持)" })

-- ============================================================================
-- Quickfix / Location List (VSCode: 問題パネル)
-- ============================================================================

map("n", "<Leader>qo", "<Cmd>copen<CR>", { desc = "Quickfix リストを開く" })
map("n", "<Leader>qq", "<Cmd>cclose<CR>", { desc = "Quickfix リストを閉じる" })
map("n", "]q", "<Cmd>cnext<CR>zz", { desc = "次の Quickfix 項目" })
map("n", "[q", "<Cmd>cprevious<CR>zz", { desc = "前の Quickfix 項目" })

-- ============================================================================
-- 診断 (VSCode: エラー・警告のナビゲーション)
-- ============================================================================

map("n", "]d", function() vim.diagnostic.jump({ count = 1 }) end, { desc = "次の診断へ" })
map("n", "[d", function() vim.diagnostic.jump({ count = -1 }) end, { desc = "前の診断へ" })
map("n", "<Leader>e", vim.diagnostic.open_float, { desc = "診断をフロート表示" })
map("n", "<Leader>dl", vim.diagnostic.setloclist, { desc = "診断をロケーションリストに表示" })
