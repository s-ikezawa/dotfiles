-- キーマップ設定
local map = vim.keymap.set
local opts = { noremap = true, silent = true }

-- descriptionを追加するヘルパー関数
local function desc(description)
  return vim.tbl_extend("force", opts, { desc = description })
end

-- リーダーキーの設定（既に設定されている場合はスキップ）
vim.g.mapleader = " "
vim.g.maplocalleader = " "

-- ========================================
-- 一般的なキーマップ
-- ========================================

-- Escキーの代替（insert mode）
map("i", "jk", "<ESC>", desc("インサートモードを抜ける"))
map("i", "kj", "<ESC>", desc("インサートモードを抜ける"))

-- 保存と終了
map("n", "<leader>w", ":w<CR>", desc("ファイルを保存"))
map("n", "<leader>q", ":q<CR>", desc("ウィンドウを閉じる"))
map("n", "<leader>Q", ":qa<CR>", desc("すべてのウィンドウを閉じる"))

-- 検索ハイライトをクリア
map("n", "<ESC>", ":noh<CR>", desc("検索ハイライトをクリア"))

-- ========================================
-- ウィンドウナビゲーション
-- ========================================

-- ウィンドウ間の移動
map("n", "<C-h>", "<C-w>h", desc("左のウィンドウへ移動"))
map("n", "<C-j>", "<C-w>j", desc("下のウィンドウへ移動"))
map("n", "<C-k>", "<C-w>k", desc("上のウィンドウへ移動"))
map("n", "<C-l>", "<C-w>l", desc("右のウィンドウへ移動"))

-- ウィンドウサイズの変更
map("n", "<C-Up>", ":resize +2<CR>", desc("ウィンドウの高さを増やす"))
map("n", "<C-Down>", ":resize -2<CR>", desc("ウィンドウの高さを減らす"))
map("n", "<C-Left>", ":vertical resize -2<CR>", desc("ウィンドウの幅を減らす"))
map("n", "<C-Right>", ":vertical resize +2<CR>", desc("ウィンドウの幅を増やす"))

-- ウィンドウ分割
map("n", "<leader>sv", ":vsplit<CR>", desc("垂直分割"))
map("n", "<leader>sh", ":split<CR>", desc("水平分割"))

-- ========================================
-- バッファ操作
-- ========================================

-- バッファ間の移動
map("n", "<S-l>", ":bnext<CR>", desc("次のバッファへ移動"))
map("n", "<S-h>", ":bprevious<CR>", desc("前のバッファへ移動"))

-- バッファを閉じる
map("n", "<leader>bd", ":bdelete<CR>", desc("現在のバッファを閉じる"))

-- ========================================
-- テキスト編集
-- ========================================

-- インデント調整（ビジュアルモードで選択を保持）
map("v", "<", "<gv", desc("インデントを減らす（選択を保持）"))
map("v", ">", ">gv", desc("インデントを増やす（選択を保持）"))

-- 行の移動
map("n", "<A-j>", ":m .+1<CR>==", desc("現在行を下へ移動"))
map("n", "<A-k>", ":m .-2<CR>==", desc("現在行を上へ移動"))
map("v", "<A-j>", ":m '>+1<CR>gv=gv", desc("選択行を下へ移動"))
map("v", "<A-k>", ":m '<-2<CR>gv=gv", desc("選択行を上へ移動"))

-- 行の複製
map("n", "<leader>d", "yyp", desc("現在行を複製"))

-- 選択したテキストをペーストで置換（レジスタを保持）
map("v", "p", '"_dP', desc("レジスタを保持してペースト"))

-- ========================================
-- クリップボード操作
-- ========================================

-- システムクリップボードへのコピー
map("n", "<leader>y", '"+y', desc("システムクリップボードへヤンク"))
map("v", "<leader>y", '"+y', desc("システムクリップボードへヤンク"))
map("n", "<leader>Y", '"+Y', desc("行全体をシステムクリップボードへヤンク"))

-- システムクリップボードからペースト
map("n", "<leader>p", '"+p', desc("システムクリップボードからペースト"))
map("v", "<leader>p", '"+p', desc("システムクリップボードからペースト"))

-- ========================================
-- ターミナルモード
-- ========================================

-- ターミナルモードを抜ける
map("t", "<ESC>", "<C-\\><C-n>", desc("ターミナルモードを抜ける"))
map("t", "jk", "<C-\\><C-n>", desc("ターミナルモードを抜ける"))

-- ターミナルモードでのウィンドウナビゲーション
map("t", "<C-h>", "<C-\\><C-n><C-w>h", desc("左のウィンドウへ移動"))
map("t", "<C-j>", "<C-\\><C-n><C-w>j", desc("下のウィンドウへ移動"))
map("t", "<C-k>", "<C-\\><C-n><C-w>k", desc("上のウィンドウへ移動"))
map("t", "<C-l>", "<C-\\><C-n><C-w>l", desc("右のウィンドウへ移動"))

-- ========================================
-- 便利な機能
-- ========================================

-- カーソル位置を中央に保持しながらスクロール
map("n", "<C-d>", "<C-d>zz", desc("下スクロール（中央保持）"))
map("n", "<C-u>", "<C-u>zz", desc("上スクロール（中央保持）"))

-- 検索結果を中央に表示
map("n", "n", "nzzzv", desc("次の検索結果（中央表示）"))
map("n", "N", "Nzzzv", desc("前の検索結果（中央表示）"))

-- 全選択
map("n", "<C-a>", "ggVG", desc("全選択"))

-- 行頭・行末へ移動
map("n", "H", "^", desc("行頭へ移動"))
map("n", "L", "$", desc("行末へ移動"))

-- ========================================
-- タブ操作
-- ========================================

map("n", "<leader>tn", ":tabnew<CR>", desc("新しいタブを開く"))
map("n", "<leader>tc", ":tabclose<CR>", desc("タブを閉じる"))
map("n", "<leader>to", ":tabonly<CR>", desc("他のタブをすべて閉じる"))
map("n", "<leader>1", "1gt", desc("タブ1へ移動"))
map("n", "<leader>2", "2gt", desc("タブ2へ移動"))
map("n", "<leader>3", "3gt", desc("タブ3へ移動"))
map("n", "<leader>4", "4gt", desc("タブ4へ移動"))
map("n", "<leader>5", "5gt", desc("タブ5へ移動"))

-- ========================================
-- クイックフィックス・ロケーションリスト
-- ========================================

map("n", "<leader>co", ":copen<CR>", desc("クイックフィックスを開く"))
map("n", "<leader>cc", ":cclose<CR>", desc("クイックフィックスを閉じる"))
map("n", "]q", ":cnext<CR>", desc("次のクイックフィックス項目"))
map("n", "[q", ":cprev<CR>", desc("前のクイックフィックス項目"))

-- ========================================
-- その他の便利な機能
-- ========================================

-- 現在のファイルパスをコピー
map("n", "<leader>cp", ':let @+ = expand("%:p")<CR>', desc("ファイルパスをコピー"))

-- コマンドモードでのEmacs風キーバインド
map("c", "<C-a>", "<Home>", { noremap = true, desc = "行頭へ移動" })
map("c", "<C-e>", "<End>", { noremap = true, desc = "行末へ移動" })

-- スペルチェックのトグル
map("n", "<leader>ts", ":set spell!<CR>", desc("スペルチェックをトグル"))

-- 行番号の相対表示トグル
map("n", "<leader>tr", ":set relativenumber!<CR>", desc("相対行番号をトグル"))

-- 空白文字の表示トグル
map("n", "<leader>tl", ":set list!<CR>", desc("空白文字表示をトグル"))
